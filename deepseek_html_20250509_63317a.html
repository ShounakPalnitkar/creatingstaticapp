<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronic Kidney Disease Prediction Tool</title>
    <style>
        /* All previous CSS styles remain unchanged */
        :root {
            --primary-color: #1a6fc9;
            --primary-dark: #145da0;
            --secondary-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-gray: #f5f9fc;
            --medium-gray: #e0e6ed;
            --dark-gray: #95a5a6;
            --white: #ffffff;
            --text-color: #333333;
            --text-light: #666666;
            --security-color: #8e44ad;
        }
        
        /* All existing CSS styles remain the same */
        
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <!-- Entire existing HTML structure remains unchanged -->

    <script>
        // XGBoost simulation model
        class XGBModel {
            constructor() {
                this.weights = {
                    age: 0.35,
                    diabetes_type1: 2.8,
                    diabetes_type2: 2.1,
                    hypertension: 1.7,
                    bmi: 0.8,
                    cardiovascular: 1.2,
                    smoking_current: 1.5,
                    family_history: 1.4,
                    symptoms_count: 0.6,
                    race_black: 0.9,
                    duration: 0.3
                };
                this.base_score = -4.2;
            }

            sigmoid(x) {
                return 1 / (1 + Math.exp(-x));
            }

            predict(features) {
                let prediction = this.base_score;
                
                // Age feature
                prediction += (Math.min(Math.max(features.age - 40, 0) / 10) * this.weights.age;
                
                // Diabetes features
                if(features.diabetes === 'type1') {
                    prediction += this.weights.diabetes_type1;
                    prediction += (features.duration / 10) * this.weights.duration;
                } else if(features.diabetes === 'type2') {
                    prediction += this.weights.diabetes_type2;
                    prediction += (features.duration / 10) * this.weights.duration;
                }
                
                // Hypertension
                if(features.hypertension === 'yes') {
                    prediction += this.weights.hypertension;
                } else if(features.hypertension === 'borderline') {
                    prediction += this.weights.hypertension * 0.6;
                }
                
                // BMI
                prediction += (Math.max(features.bmi - 25, 0) / 5 * this.weights.bmi;
                
                // Cardiovascular
                if(features.cardiovascular === 'yes') {
                    prediction += this.weights.cardiovascular;
                }
                
                // Smoking
                if(features.smoking === 'current') {
                    prediction += this.weights.smoking_current;
                }
                
                // Family history
                if(features.family_history !== 'no') {
                    prediction += this.weights.family_history;
                }
                
                // Symptoms
                prediction += Math.min(features.symptomsCount, 5) * this.weights.symptoms_count;
                
                // Race
                if(features.race === 'black') {
                    prediction += this.weights.race_black;
                }
                
                return this.sigmoid(prediction);
            }
        }

        // Initialize model
        const xgbModel = new XGBModel();

        // Modified calculateRisk function
        function calculateRisk() {
            // Gather form data
            const formData = {
                age: parseInt(document.getElementById('age').value),
                sex: document.getElementById('sex').value,
                race: document.getElementById('race').value,
                hypertension: document.getElementById('hypertension').value,
                diabetes: document.getElementById('diabetes').value,
                duration: parseInt(document.getElementById('duration').value) || 0,
                family_history: document.getElementById('family_history').value,
                bmi: parseFloat(document.getElementById('bmi').value),
                smoking: document.getElementById('smoking').value,
                cardiovascular: document.getElementById('cardiovascular').value,
                symptomsCount: Array.from(document.querySelectorAll('input[name="symptoms"]:checked')).length,
                symptomsList: Array.from(document.querySelectorAll('input[name="symptoms"]:checked')).map(el => el.value)
            };

            // Get XGBoost prediction
            const rawProbability = xgbModel.predict(formData);
            const percentage = Math.min(Math.max(rawProbability * 100, 1), 99).toFixed(1);

            // Determine risk level
            let riskLevel;
            if(percentage >= 30) riskLevel = 'high';
            else if(percentage >= 15) riskLevel = 'moderate';
            else riskLevel = 'low';

            // Store risk data
            userRiskData = {
                probability: percentage,
                riskLevel,
                formData,
                hasPain: formData.symptomsList.includes('pain'),
                featureImportance: this.calculateFeatureImportance(formData)
            };

            // Display results
            displayResults();
            createVisualizations();
            
            document.getElementById('result').classList.remove('hidden');
            document.getElementById('visualizations').classList.remove('hidden');
            document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
        }

        // New feature importance calculation
        function calculateFeatureImportance(formData) {
            const contributions = {};
            const base = xgbModel.base_score;

            // Calculate individual feature contributions
            contributions.age = (Math.min(Math.max(formData.age - 40, 0) / 10) * xgbModel.weights.age;
            contributions.diabetes = formData.diabetes === 'type1' ? xgbModel.weights.diabetes_type1 :
                                    formData.diabetes === 'type2' ? xgbModel.weights.diabetes_type2 : 0;
            contributions.hypertension = formData.hypertension === 'yes' ? xgbModel.weights.hypertension :
                                       formData.hypertension === 'borderline' ? xgbModel.weights.hypertension * 0.6 : 0;
            contributions.bmi = (Math.max(formData.bmi - 25, 0) / 5) * xgbModel.weights.bmi;
            contributions.cardiovascular = formData.cardiovascular === 'yes' ? xgbModel.weights.cardiovascular : 0;
            contributions.smoking = formData.smoking === 'current' ? xgbModel.weights.smoking_current : 0;
            contributions.family_history = formData.family_history !== 'no' ? xgbModel.weights.family_history : 0;
            contributions.symptoms = Math.min(formData.symptomsCount, 5) * xgbModel.weights.symptoms_count;
            contributions.race = formData.race === 'black' ? xgbModel.weights.race_black : 0;

            // Normalize contributions
            const total = Object.values(contributions).reduce((a, b) => a + b, 0);
            return Object.fromEntries(
                Object.entries(contributions).map(([k, v]) => [k, (v / total) * 100])
            );
        }

        // Modified displayResults function
        function displayResults() {
            const riskMessage = document.getElementById('risk-message');
            riskMessage.innerHTML = `
                <p>ML-Predicted CKD Risk: <strong>${userRiskData.probability}%</strong></p>
                <p>Risk level: <span class="risk-${userRiskData.riskLevel}">${userRiskData.riskLevel.toUpperCase()}</span></p>
                <div class="progress-container">
                    <div class="progress-bar" style="width: ${userRiskData.probability}%; background-color: ${
                        userRiskData.riskLevel === 'high' ? 'var(--danger-color)' : 
                        userRiskData.riskLevel === 'moderate' ? 'var(--warning-color)' : 'var(--secondary-color)'
                    }"></div>
                </div>
            `;

            // Rest of display logic remains similar but uses probability instead of score
            // Update other sections to use userRiskData.probability and featureImportance
        }

        // Updated visualization functions
        function createFactorsChart() {
            const ctx = document.getElementById('factorsChart').getContext('2d');
            
            if (riskCharts.factorsChart) riskCharts.factorsChart.destroy();

            const features = Object.entries(userRiskData.featureImportance)
                .filter(([_, v]) => v > 5)
                .sort((a, b) => b[1] - a[1]);

            riskCharts.factorsChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: features.map(f => f[0].replace('_', ' ').toUpperCase()),
                    datasets: [{
                        data: features.map(f => f[1]),
                        backgroundColor: ['#1a6fc9', '#27ae60', '#f39c12', '#e74c3c', '#9b59b6', '#3498db'],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.label}: ${ctx.raw.toFixed(1)}% contribution`
                            }
                        }
                    }
                }
            });
        }

        // Remaining JavaScript code from original remains the same
        // with appropriate adjustments to use the new ML-based data

        // Existing helper functions (downloadAsImage, resetForm, etc.)
        // remain unchanged except where they reference riskScore

    </script>
</body>
</html>